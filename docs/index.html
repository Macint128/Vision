<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>손에 가려지는 아이콘</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
    }

    video {
      display: none;
    }

    canvas, .icon {
      position: absolute;
      top: 0;
      left: 0;
    }

    .icon {
      z-index: 2;
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      font-weight: bold;
      transition: transform 0.15s ease-in-out;
    }
  </style>
</head>
<body>

  <video id="input_video" autoplay playsinline muted></video>
  <canvas id="mask-canvas"></canvas>
  <div id="icon" class="icon">📦</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('mask-canvas');
    const ctx = canvas.getContext('2d');
    const icon = document.getElementById('icon');

    let handCenter = { x: 0, y: 0 };
    let iconPos = { x: 300, y: 300 };

    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    hands.onResults((results) => {
      const vw = video.videoWidth;
      const vh = video.videoHeight;

      canvas.width = vw;
      canvas.height = vh;

      ctx.clearRect(0, 0, vw, vh);

      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        // 손 중심 좌표 계산 (대략 중지 아래)
        const palmBase = landmarks[0];
        handCenter.x = palmBase.x * vw;
        handCenter.y = palmBase.y * vh;

        // 마스킹: 손 영역 오려내기
        ctx.save();
        ctx.fillStyle = "black";
        ctx.beginPath();
        landmarks.forEach(pt => {
          ctx.lineTo(pt.x * vw, pt.y * vh);
        });
        ctx.closePath();

        ctx.globalCompositeOperation = 'source-over';
        ctx.fill(); // 배경 검정

        ctx.globalCompositeOperation = 'destination-out'; // 손 부분 오려내기
        ctx.beginPath();
        landmarks.forEach(pt => {
          ctx.lineTo(pt.x * vw, pt.y * vh);
        });
        ctx.closePath();
        ctx.fill();

        ctx.restore();
      }
    });

    function animate() {
      // 부드럽게 따라가기 (lerp)
      iconPos.x += (handCenter.x - iconPos.x) * 0.15;
      iconPos.y += (handCenter.y - iconPos.y) * 0.15;

      icon.style.transform = `translate(${iconPos.x - 40}px, ${iconPos.y - 40}px)`;
      requestAnimationFrame(animate);
    }

    const camera = new Camera(video, {
      onFrame: async () => {
        await hands.send({ image: video });
      },
      width: 1280,
      height: 720,
      facingMode: 'environment'
    });
    camera.start();
    animate();
  </script>

</body>
</html>
