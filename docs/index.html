<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>VisionOS ìŠ¤íƒ€ì¼ ì›¹</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Helvetica Neue', sans-serif;
    }

    video#rearCamera {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }

    #app-icon {
      position: absolute;
      width: 80px;
      height: 80px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #333;
      cursor: pointer;
      transition: transform 0.2s;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body>

  <video id="rearCamera" autoplay playsinline muted></video>
  <video id="frontCamera" autoplay playsinline muted style="display: none;"></video>

  <div id="app-icon">ì•±</div>

  <script>
    const rearVideo = document.getElementById('rearCamera');
    const frontVideo = document.getElementById('frontCamera');
    const appIcon = document.getElementById('app-icon');

    // 1. ì „ë©´ ì¹´ë©”ë¼: ëˆˆë™ì ì¶”ì ìš©
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    }).then(stream => {
      frontVideo.srcObject = stream;
      webgazer.setVideoElement(frontVideo);
      webgazer.setGazeListener((data, time) => {
        if (data) {
          appIcon.style.left = `${data.x - 40}px`;
          appIcon.style.top = `${data.y - 40}px`;
        }
      });
      webgazer.showVideo(false);       // ì „ë©´ ì¹´ë©”ë¼ ì˜ìƒ ìˆ¨ê¸°ê¸°
      webgazer.showFaceOverlay(false); // ì–¼êµ´ í”„ë ˆì„ë„ ìˆ¨ê¹€
      webgazer.showFaceFeedbackBox(false); // í”¼ë“œë°± ë°•ìŠ¤ë„ ìˆ¨ê¹€
      webgazer.begin();
    });


    // 2. í›„ë©´ ì¹´ë©”ë¼: í™”ë©´ ì¶œë ¥ + ì† ì¶”ì ìš©
    navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" } },
      audio: false
    }).then(stream => {
      rearVideo.srcObject = stream;

      const rearCam = new Camera(rearVideo, {
        onFrame: async () => {
          await hands.send({ image: rearVideo });
        },
        width: 640,
        height: 480
      });

      rearCam.start();
    });

    // 3. MediaPipe ì† ì¶”ì 
    let pinchStartTime = null;
    let isDragging = false;

    const hands = new Hands({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.5
    });

    function getDistance(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    hands.onResults((results) => {
      if (results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8];

        const distance = getDistance(thumbTip, indexTip);

        if (distance < 0.05) {
          if (!pinchStartTime) {
            pinchStartTime = Date.now();
          }

          const duration = Date.now() - pinchStartTime;

          if (duration > 2000 && !isDragging) {
            isDragging = true;
            console.log("ğŸ‘‰ ë“œë˜ê·¸ ëª¨ë“œ ì§„ì…");
          }

          if (isDragging) {
            const x = (thumbTip.x + indexTip.x) / 2;
            const y = (thumbTip.y + indexTip.y) / 2;
            appIcon.style.left = `${window.innerWidth * x - 40}px`;
            appIcon.style.top = `${window.innerHeight * y - 40}px`;
          }

        } else {
          if (pinchStartTime) {
            const duration = Date.now() - pinchStartTime;
            if (duration < 2000) {
              console.log("âœ… ì§§ì€ í•€ì¹˜ â†’ ì•± ì‹¤í–‰");
              alert("ì•± ì‹¤í–‰!");
            }
            pinchStartTime = null;
            isDragging = false;
          }
        }
      }
    });
  </script>
</body>
</html>
